<!DOCTYPE html>
<meta charset="utf-8">
<meta http-equiv="refresh" content="300000">
<html>
<style>
	/* Beautiful CSS styling here for now. */
	/*
	path {
		stroke: white;
		stroke-width: 0.25px;
		fill: grey;
	}*/

	.linepath {
		stroke: black;
		opacity: 0;
	}

	.draggable {
		cursor: move;
	}

	.myTooltip {                                                       /* NEW */
	background: #eee; 
    border: 2px solid #a1a1a1;	
	border-radius: 25px;                                              /* NEW */
	box-shadow: 0 0 5px #999999;                                    /* NEW */
	color: #333;                                                    /* NEW */
	display: none;                                                  /* NEW */
	font-size: 12px;                                                /* NEW */
	left: 130px;                                                    /* NEW */
	padding: 8px;                                                  /* NEW */
	position: absolute;                                             /* NEW */
	text-align: center;                                             /* NEW */
	top: 95px;                                                      /* NEW */
    z-index: 10;                                                    /* NEW */
	} 

	.circle {
		fill: ForestGreen;
		opacity: 1;	
		stroke-width: 0.2px;
		stroke: black;
	}

	.world {
		fill: gray;
		stroke-width: 0.25px;
		stroke: gray;
	}

	.sphere, .graticule {
	  stroke: gray; 
	  stroke-width: 0.1px;
	}

	path {
	  fill: none;
	  stroke-linejoin: round;
	}

</style> 
<body>




<!-- <script src="http://d3js.org/d3.geo.projection.v0.min.js"></script> -->
<script type="text/javascript" src="js/d3.v3.min.js"></script>
<script type="text/javascript" src="js/topojson.v1.min.js"></script>
<!-- <script src="//code.jquery.com/jquery-1.11.2.min.js"></script> -->
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css"> -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>


<h2>Year: </h2> 
<button type="button" class="btn btn-warning" id="animation_btn">Pause</button>
<button type="button" class="btn btn-info" id="paths_btn" disabled="disabled">Hide Paths</button>
<button type="button" class="btn btn-info" id="people_btn">Hide People</button>
<div id="mapViz"></div>

	<script>
		/*Java java */
	//var graticule = d3.geo.graticule();
	//Needed for? ^
	var width = 960,
		height = 500,		//http://bl.ocks.org/patricksurry/6621971
	    rotate = -10;       

	var projection = d3.geo.mercator()
		.rotate([rotate,0])
		.translate([width/2, height/2])
		//.clipAngle(90 + 1e-6) // http://bl.ocks.org/mbostock/5731578 gets rid of the white space strip
		//.precision(.3)
		.center([15, 20])
		.scale(180)

	var currentZoom = 1, // Global variable for zoom level when creating circles. Needed for dynamic zoom.
		circleSize = 4; // Size of circles

	var color = d3.scale.category10();

	var path = d3.geo.path()
		.projection(projection);

	var λ = d3.scale.linear()
	    .domain([0, width])
	    .range([-180, 180]);

	var φ = d3.scale.linear()
	    .domain([0, height])
	    .range([90, -90]);

	var drag = d3.behavior.drag()
		//.origin(function(d) {return d; })
		.on("dragstart", dragstarted)
		.on("drag", dragged)
		.on("dragend", dragended);

	var zoom = d3.behavior.zoom()
		.scaleExtent([.9, 30]) // Controls the amount of allowable magnification.
		.on("zoom", zoomed);

	var mainSVG = d3.select("#mapViz") // Select the "mapViz" div defined earlier in <body>
		.append("svg")
		.attr("width", width)
		.attr("height", height)
		.call(zoom)
		//.on('mousedown.zoom',null);
//		.append("g")
		.style("background-color", "#A5DEFF") //Color the water in the main svg
		
	//	.attr("class", "draggable")
	//.append("g")

		//.call(drag);

	var graticule = d3.geo.graticule();  //Graticule is a geographic grid.

	var worldGroup = mainSVG.append("g");

	//worldGroup.append("path")
	//	.datum({type: "Sphere"})
	//	.attr("class", "graticule")
	//	.attr("d", path)

	worldGroup.append("path")
		.datum(graticule)
		.attr("class", "graticule")
		.attr("d", path)


	//var g = mainSVG.append("g");

	//var worldGroup = mainSVG.append("g");
	//var bornGroup = mainSVG.append("g");
	//var acquiredGroup = mainSVG.append("g");

// http://zeroviscosity.com/d3-js-step-by-step/step-5-adding-tooltips   //////
        var myTooltip = d3.select('#mapViz')                              // NEW
          .append('div')                                                // NEW
          .attr('class', 'myTooltip');                                    // NEW

        myTooltip.append('div')                                           // NEW
          .attr('class', 'name');                                       // NEW
             
        myTooltip.append('div')                                           // NEW
          .attr('class', 'count');                                      // NEW

        myTooltip.append('div')                                           // NEW
          .attr('class', 'percent');                                    // NEW

        myTooltip.append('div')                                           // NEW
          .attr('class', 'field');                                      // NEW

        myTooltip.append('div')                                           // NEW
          .attr('class', 'institution');                                // NEW

        myTooltip.append('div')                                           // NEW
          .attr('class', 'born');                                       // NEW

        myTooltip.append('div')                                           // NEW
          .attr('class', 'city');                                       // NEW
//////////////////////////////////////////////////////////////////////////////




	d3.json("data/world-110m.json", function(error, world) {


		//draw the world
		//worldGroup.selectAll("path")
		//	.data(topojson.feature(world, world.objects.countries).features)
		//	.enter()
		//	.append("path")
		//		.attr("d", path)
		//		.attr("class", "world");

		//worldGroup.append("path")
		//	.datum(graticule)
		//	.attr("class", "graticule")
		//	.attr("d", path)
		//	.style("fill", "#A5DEFF") // Color ocean blue.

		worldGroup.append("path")
			.datum(topojson.feature(world, world.objects.countries))
			.attr("class", "boundary")
			.attr("d", path)
			.style("fill", "#CDC")
			.style("stroke-width", 0.3)
			.style("stroke", "gray")


		d3.csv("data/nobel_locations.csv", function(error, nobel) {

/*
			function agg_year(leaves) {
				// leaves here is an array of filtered data from d3.nest().key()
				// in this case, it's each subset of cities, for each year
				// We can get the number of entries with length on the subset
				// which contains one data object for each row
				var total_per_year = leaves.length;

				return {
					'total_per_year': total_per_year
				};
			}

			var nested = d3.nest()
							.key( function(d) {
								return d.year;
							})
							.rollup(agg_year)
							.entries(cities)

			// Now nested is an aggregated dataset of counts of number of nobel prize
			// winners for each year.

*/
			function jitter(min, max) {
			    return Math.random() * (max - min) + min;
			}

			years = d3.set() // Set of years for iterating through.

			nobel.forEach( function(d){
				// Convert year to interger
  				d.year_won = +d.year_won
  				// Translate lon/lat into x/y once for using later.
  				// Jitter the coordinates slightly to avoid some overplotting.
  				d.birth_x = projection([d.born_lon, d.born_lat])[0] * jitter(.9999, 1)
  				d.birth_y = projection([d.born_lon, d.born_lat])[1] * jitter(.9999, 1)
  				d.acquired_x = projection([d.award_lon, d.award_lat])[0] * jitter(.99, 1)
  				d.acquired_y = projection([d.award_lon, d.award_lat])[1] * jitter(.99, 1)
  				// Grab years for our years set while we're here.
  				years.add(+d.year_won)
			})

			years = years.values() // Get the values in the set.

			//debugger;

			function update(year) {

	            d3.select("h2")
	              .text("Year: " + year);




				//debugger;

				

				//nobelLines.exit().remove();
				//debugger;

				function makeArc1(d) {
					var dx = d.birth_x,
						dy = d.birth_y,
						dr = Math.sqrt(dx*dx + dy*dy);
					return "M" + d.birth_x + "," + d.birth_y + "A" + dr + "," + dr + " 0 0,1 " + d.birth_x + "," + d.birth_y;
				}

				function makeArc2(d) {
					var dx = d.acquired_x - d.birth_x,
						dy = d.acquired_y - d.birth_y,
						dr = Math.sqrt(dx*dx + dy*dy);
					return "M" + d.birth_x + "," + d.birth_y + "A" + dr + "," + dr + " 0 0,1 " + d.acquired_x + "," + d.acquired_y;
				}


				function translateAlong(path) {
					 var l = path.getTotalLength();
					 return function(d, i, a) {
					 	return function(t) {
					 		var p = path.getPointAtLength(t * l);
					 			return "translate(" + p.x + "," + p.y + ")";
					 	};
					 };
				}			



				var filtered = nobel.filter( function (d) { return +d.year_won === +year; })

				var people = worldGroup.selectAll("people")
									.data(filtered)
									.enter()
				
				function lineOpacity() {
					if (d3.select('#paths_btn').text() ==='Show Paths'){return 0
					}else{return 0.15}
				}

				var arcs = people.append("svg:path")
					.attr("class", "arc linepath nobel_winner")
					// Make lines for each data point with the start and end at the 
					// same birth country lon/lat
					//.attr("x1", function(d) { return d.birth_x; })
					//.attr("y1", function(d) { return d.birth_y; })
					//.attr("x2", function(d) { return d.birth_x; })
					//.attr("y2", function(d) { return d.birth_y; })
					.attr("d", makeArc1)
					// transition one end point from to the country acquired lon/lat
					.transition()
					.delay(500)
					.duration(3000)
					.style("opacity", lineOpacity)
					//.attr("x2", function(d) { return d.acquired_x })
					//.attr("y2", function(d) { return d.acquired_y; });
					.attr("d", makeArc2);

					//nobelCircles.exit().remove()

				// Create see through empty circles for each person at each birth country 
				// for each year. Add circles after lines to keep them on top for tooltip.
				//var nobelCircles = worldGroup.selectAll("circle")
				//					.data(filtered)

				/*
				people.append("circle")
					.on("mouseover", mouseover)
					.on("mouseout", mouseout)
					.on("mousedown", animateFirst)
						.attr("class", "circle")
						.attr("cx", function(d) { return d.birth_x; })
						.attr("cy", function(d) { return d.birth_y; })
						.attr("r", 0)
						.transition()
						.duration(250)
						.attr("r", 10)
						.ease("bounce")
						.transition()
						.duration(250)
						.ease("bounce")
						.attr("r", 3)
				// Transition the circle to the countries acquired, while filling in the
				// circles opacity to 0.1 to be seen.
				//worldGroup.selectAll("circle")
						.transition()
						.duration(3000)
						.ease("cubic-in-out") //default
						.attr("cx", function(d) { return d.acquired_x; })
						.attr("cy", function(d) { return d.acquired_y; })
						.attr("r", 2)
						.style("opacity", .3)
						.style("fill", "gold")
				*/


				var circles = people.append("circle")
					.on("mouseover", mouseover)
					.on("mouseout", mouseout)
					.on("mousedown", animateFirst)
						.attr("class", "circle nobel_winner")
							.attr("r", 0)
							.attr("transform", function(d) {
								return "translate(" + d.birth_x + "," + d.birth_y + ")"; })
						.transition()
						.duration(250)
						.attr("r", circleSize/currentZoom)
						.ease("bounce")
						.transition()
						.duration(250)
						.ease("bounce")
						.attr("r", (circleSize/2) /currentZoom)
						.transition()
						.duration(3000)
						.ease("cubic-in-out") //default;
						.attr("transform", function(d) {
							return "translate(" + d.acquired_x + "," + d.acquired_y + ")"; })
						.attr("r", circleSize/currentZoom)
						.style("opacity", .4)
						.style("fill", function(d) { return color(d.nobel_field);})
				


				//circle.transition()
				//	.attrTween("transform", translateAlong(path.node()))
					
				};


			var year_idx = 0;

			// Class object for a timer to add to years_idx.
			// http://stackoverflow.com/questions/7279567/how-do-i-pause-a-window-setinterval-in-javascript/7282347#7282347
			function goYears(callback, delay) {
				var timerID, start, remaining = delay;

				// Pause the timer
				this.pause = function() {
					window.clearTimeout(timerID);
					remaining -= new Date() - start;
				};

				//Reset the timer
				//this.reset = function() {
				//	window.clearTimeout(timerID);
				//	remaining = new Date();
				//}

				var resume = function() {
					start = new Date();
					timerID = window.setTimeout(function() {
						remaining = delay;
						resume();
						callback();
					}, remaining) 
				};

				this.resume = resume;
				this.resume();
				};

			var timer = new goYears(function() {
			// If timer is being resumed after all years have already been cycled through...
				if(year_idx === 0) {
					// ... remove all circle and arc classes first to restart animation.
					d3.selectAll(".circle").remove();
					d3.selectAll(".arc").remove();
					// Reset all buttons to defaults.
					d3.select('#paths_btn').attr("disabled", "disabled");
				}

				update(+years[year_idx]);

				year_idx++

				if(year_idx >= years.length) {
					timer.pause();
					// If all years have been cycled through, reset the year index back to 0
					year_idx = 0
					// Show that button can now be used to reset the animation
					d3.select('button').text('Reset').attr('class', 'btn btn-danger')
					d3.select('#paths_btn').transition().delay(2000).attr("disabled", null)
				};
		}, 500); // Transition time in millisec between switching years.


		// Interactions / Clickables:

		//Change CSS styling on button if pause/play/reset available.
		d3.select('#animation_btn').on('click',function(d,i){
			var self = d3.select(this);
			if (self.text() === "Pause"){
				timer.pause()
				self.text("Play").attr('class', 'btn btn-success');
				d3.select('#paths_btn').transition().delay(2000).attr("disabled", null)

			}else{
				timer.resume()
				d3.select('#paths_btn').attr("disabled", "disabled")
				self.text("Pause").attr('class', 'btn btn-warning');
				
			}
		});

		// Give the option to hide paths. Only allow button when paused to avoid half/drawn paths.
		d3.select('#paths_btn').on('click', function(d,i) {
			var self = d3.select(this);

			if(self.text() === "Show Paths"){
				self.text('Hide Paths')
				d3.selectAll('.arc').transition().delay(500).duration(500).style("opacity", 0.15)
			}else{
				self.text("Show Paths")
				d3.selectAll('.arc').transition().delay(500).duration(500).style('opacity', 0.0)
			}


		})


		});

	});	



	




	//Functions:
	
	//Function to move selection to top of renedering queue.
	// http://stackoverflow.com/questions/14167863/how-can-i-bring-a-circle-to-the-front-with-d3
	d3.selection.prototype.moveToFront = function() { 
	  return this.each(function() { 
	    this.parentNode.appendChild(this); 
	  }); 
	}; 

	//Function to move selection to back of renedering queue.
	d3.selection.prototype.moveToBack = function() { 
	    return this.each(function() { 
	        var firstChild = this.parentNode.firstChild; 
	        if (firstChild) { 
	            this.parentNode.insertBefore(this, firstChild); 
	        } 
	    }); 
	};

	// Give mouseover tooltips, and clickable animations.
	function mouseover(d) {

		// Display the tooltip at the x,y coord on the #mapViz html area
		myTooltip.style("top", (d3.event.pageY + 10) + "px")
			   .style("left", (d3.event.pageX + 10) + "px");
		myTooltip.select(".name").html(d.name);
		myTooltip.select(".field").html("Field: " + d.nobel_field + ", " + d.year_won);
		myTooltip.select(".institution").html("Inst. :" + d.institution);
		myTooltip.select(".city").html("Location: " + d.award_city )
		myTooltip.select(".born").html("Born: " + d.born_city)
		myTooltip.style("display", "block");

		// When mousing over, make solid and larger
		d3.select(this)
		//	.transition()
		//	.duration(400)
			.style("opacity", .95)
			.attr("r", 3*circleSize/currentZoom)
			.attr("stroke-width", 4*currentZoom)

			//.style("fill", "red");
		//d3.select('.nobel_winner').attr('color', "red")
		// Move moused over circle to be rendered above all other circles.
		// 
		// d3.select(this).moveToFront();
		}

	function mouseout(d) {
		// Make the circle attributes return to defaults and
		// tooltip disappear when moused off of.
		d3.select(this)
		//	.transition()
		//	.duration(200)
			.style("opacity", .4)
			.attr("r", circleSize/currentZoom)

		myTooltip.style("display", "none")
		}

	// Make an animation when a circle is clicked.
	// http://christopheviau.com/d3_tutorial/
	// Make larger..
	function animateFirst() {
		d3.select(this)
		.transition()
		  .delay(0)
		  .duration(100)
		  .attr("r", (circleSize*4) /currentZoom)
		  .each("end", animateSecond)
		};
	// Then return to normal size.
	function animateSecond() {
		d3.select(this)
		  .transition()
		    .duration(200)
		    .attr("r", circleSize/currentZoom)
		    // Add for loop
		    //.each("end", animateFirst)
		};


	function zoomed() {

		//d3.event.sourceEvent.preventDefault();
		// d3.event.translate is equivalent since this d3.event is the zoom() parent zoom() function.
		// d3.event syntax used for clarity. Not sure which would be more efficient.
		//console.log(zoom.translate  ())
		window.currentZoom = d3.event.scale;
		// Scaled zooming
		// https://groups.google.com/forum/#!topic/d3-js/z9kqLRj7Puo

		worldGroup.attr("transform", "translate(" + 
				d3.event.translate.join(",") + ")scale(" + d3.event.scale + ")" )
			.style("stroke-width", 1/d3.event.scale)  // Scale lines as you zoom.
			.selectAll("circle").attr("r", circleSize/d3.event.scale); 
													  
		
		//g.selectAll("path")
		//	.attr("d", path.projection(projection));
	}

	var m0,
	    o0;

	function dragstarted(d) {
		//d3.event.sourceEvent.stopPropagation();

		var proj = projection.rotate();
		m0 = [d3.event.sourceEvent.pageX, d3.event.sourceEvent.pageY];
      	o0 = [-proj[0],-proj[1]];
		d3.select(this).classed("dragging", true);
	}

	function dragged() {
		//var p = d3.mouse(this);
		//projection.rotate( [ λ( p[0] ), φ( p[1]) ] );
      if (m0) {
        var m1 = [d3.event.sourceEvent.pageX, d3.event.sourceEvent.pageY],
            o1 = [o0[0] + (m0[0] - m1[0]) / 4, o0[1] + (m1[1] - m0[1]) / 4];
        projection.rotate([-o1[0], -o1[1]]);
    	}
		path = d3.geo.path().projection(projection);
		d3.selectAll("path").attr("d", path);		
	}

	function dragended(d) {
		d3.select(this).classed("dragging", false)
	}

//var xy = mercator([longitude, latitude])

	</script>

</body>
</html>


<!--
			var force = d3.layout.force()
				.nodes(cities)
				.size([width, height])
				.on("tick", tick)
				.charge(300)
				.gravity(0.1)

			force.start()

			node = worldGroup.selectAll("circle")
				.data(force.nodes())
				.enter()
				.append("circle")
				.style("fill", "steelblue")
				.attr("r", 10)

			function tick() {
				
				node.each(messWithPosition());

				node.attr("cx", function(d) { return d.birth_x; })
					.attr("cy", function(d) { return d.birth_y})
			}

			function messWithPosition(){
				return function(d) {
					d.birth_x += 0
					d.birth_y += 0
				}
			}
*/ -->