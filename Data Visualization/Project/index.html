<!DOCTYPE html>
<meta charset="utf-8">
<meta http-equiv="refresh" content="120">
<html>
<style>
	/* Beautiful CSS styling here for now. */
	/*
	path {
		stroke: white;
		stroke-width: 0.25px;
		fill: grey;
	}*/

	.linepath {
		stroke: DarkRed;
		opacity: 1;
	}

	.draggable {
		cursor: move;
	}

	.tooltip {                                                       /* NEW */
	background: #eee; 
    border: 2px solid #a1a1a1;	
	border-radius: 25px;                                              /* NEW */
	box-shadow: 0 0 5px #999999;                                    /* NEW */
	color: #333;                                                    /* NEW */
	display: none;                                                  /* NEW */
	font-size: 12px;                                                /* NEW */
	left: 130px;                                                    /* NEW */
	padding: 8px;                                                  /* NEW */
	position: absolute;                                             /* NEW */
	text-align: center;                                             /* NEW */
	top: 95px;                                                      /* NEW */

    z-index: 10;                                                    /* NEW */
	} 

	.circle {
		fill: ForestGreen;
		opacity: 1;	
		stroke-width: 0.1px;
		stroke: black;
	}

	.circle:hover {
	  fill: DarkRed;
	  opacity: 0;
	}

	.world {
		fill: gray;
		stroke-width: 0.25px;
		stroke: black;
	}


</style> 
<body>

<h2>Year: </h2> 


	<div id="mapViz"></div>
	<!-- <script src="http://d3js.org/d3.geo.projection.v0.min.js"></script> -->
	<script type="text/javascript" src="js/d3.v3.min.js"></script>
	<script type="text/javascript" src="js/topojson.v1.min.js"></script>
	<!-- <script src="//code.jquery.com/jquery-1.11.2.min.js"></script> -->
	<!-- <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script> -->
	<!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->

	<script>
		/*Java java */
	//var graticule = d3.geo.graticule();
	//Needed for? ^
	var width = 960,
		height = 500;

	var projection = d3.geo.equirectangular()
		//.center([0, 5])
		.scale(175)
		//.rotate([-135, -30, 0])
		.translate([width/2, height/2])
		//.clipAngle(90);
		.precision(.1);

	var path = d3.geo.path()
		.projection(projection);

	var λ = d3.scale.linear()
	    .domain([0, width])
	    .range([-180, 180]);

	var φ = d3.scale.linear()
	    .domain([0, height])
	    .range([90, -90]);

	var drag = d3.behavior.drag()
		//.origin(function(d) {return d; })
		.on("dragstart", dragstarted)
		.on("drag", dragged)
		.on("dragend", dragended);

	var zoom = d3.behavior.zoom()
		.scaleExtent([1, 10])
		.on("zoom.redraw", zoomed);

	var mainSVG = d3.select("#mapViz") // Select the "mapViz" div defined earlier in <body>
		.append("svg")
		.attr("width", width)
		.attr("height", height)
		.style("background-color", "#A5DEFF") //Color the water in the main svg
		
	//	.attr("class", "draggable")
	//.append("g")
		.call(zoom)
		//.call(drag);



	//var g = mainSVG.append("g");

	var worldGroup = mainSVG.append("g");
	var bornGroup = mainSVG.append("g");
	var acquiredGroup = mainSVG.append("g");

// http://zeroviscosity.com/d3-js-step-by-step/step-5-adding-tooltips   //////
        var tooltip = d3.select('#mapViz')                              // NEW
          .append('div')                                                // NEW
          .attr('class', 'tooltip');                                    // NEW

        tooltip.append('div')                                           // NEW
          .attr('class', 'name');                                       // NEW
             
        tooltip.append('div')                                           // NEW
          .attr('class', 'count');                                      // NEW

        tooltip.append('div')                                           // NEW
          .attr('class', 'percent');                                    // NEW

        tooltip.append('div')                                           // NEW
          .attr('class', 'field');                                      // NEW

        tooltip.append('div')                                           // NEW
          .attr('class', 'institution');                                // NEW

        tooltip.append('div')                                           // NEW
          .attr('class', 'city');                                       // NEW
//////////////////////////////////////////////////////////////////////////////

	d3.json("data/world-110m2.json", function(error, world) {


		//draw the world
		worldGroup.selectAll("path")

			.data(topojson.feature(world, world.objects.countries).features)
			.enter()
			.append("path")
				.attr("d", path)
				.attr("class", "world");

		d3.csv("data/all_acquired.csv", function(error, cities) {

			years = d3.set()

			cities.forEach( function(d){
				// Convert year to interger
  				years.add(+d.year)
			})
			years = years.values()
/*
			function agg_year(leaves) {
				// leaves here is an array of filtered data from d3.nest().key()
				// in this case, it's each subset of cities, for each year
				// We can get the number of entries with length on the subset
				// which contains one data object for each row
				var total_per_year = leaves.length;

				return {
					'total_per_year': total_per_year
				};
			}

			var nested = d3.nest()
							.key( function(d) {
								return d.year;
							})
							.rollup(agg_year)
							.entries(cities)

			// Now nested is an aggregated dataset of counts of number of nobel prize
			// winners for each year.
*/
			cities.forEach( function(d){
				// Convert year to interger
  				d.year = +d.year
  				//Translate lon/lat into x/y once for using later.
  				d.birth_x = projection([d.birth_lon, d.birth_lat])[0]
  				d.birth_y = projection([d.birth_lon, d.birth_lat])[1]
  				d.acquired_x = projection([d.acquired_lon, d.acquired_lat])[0]
  				d.acquired_y = projection([d.acquired_lon, d.acquired_lat])[1]
			})

			//debugger;

			function update(year) {

            d3.select("h2")
              .text("Year: " + year);

			var filtered = cities.filter( function (d) { return d.year === year; })


			//debugger;
			var nobelLines = worldGroup.selectAll("line")
								.data(filtered, function(d) { return d.year; })
			

			//nobelLines.exit().remove();
			//debugger;

			nobelLines.enter()
				.append("line")
				.attr("class", "linepath")
				// Make lines for each data point with the start and end at the 
				// same birth country lon/lat
				.attr("x1", function(d) { return d.birth_x; })
				.attr("y1", function(d) { return d.birth_y; })
				.attr("x2", function(d) { return d.birth_x; })
				.attr("y2", function(d) { return d.birth_y; })
				// transition one end point from to the country acquired lon/lat
				.transition()
				.delay(500)
				.duration(3000)
				.style("opacity", .2)
				.attr("x2", function(d) { return d.acquired_x })
				.attr("y2", function(d) { return d.acquired_y; });
				
				//nobelCircles.exit().remove()

				// Create see through empty circles for each person at each birth country 
				// for each year. Add circles after lines to keep them on top for tooltip.
				var nobelCircles = worldGroup.selectAll("circle")
									.data(filtered, function(d) { return d.year; })

				nobelCircles.enter()
				//.append("a")
				//	.attr("xlink:href", function(d) {
				//		return "https://www.google.com/search?q=" + d.city;
				//	})
				.append("circle")
				.on("mouseover", mouseover)
				.on("mouseout", mouseout)
				.on("mousedown", animateFirst)
					.attr("class", "circle")
					.attr("cx", function(d) { return d.birth_x; })
					.attr("cy", function(d) { return d.birth_y; })
					.attr("r", 0)
					.transition()
					.duration(250)
					.attr("r", 10)
					.ease("bounce")
					.transition()
					.duration(250)
					.ease("bounce")
					.attr("r", 3)
			// Transition the circle to the countries acquired, while filling in the
			// circles opacity to 0.1 to be seen.
			//worldGroup.selectAll("circle")
					.transition()
					.duration(3000)
					.ease("cubic-in-out") //default
					.attr("cx", function(d) { return d.acquired_x; })
					.attr("cy", function(d) { return d.acquired_y; })
					.attr("r", 2)
					.style("opacity", .3)
					.style("fill", "gold")

			// Give mouseover tooltips, and clickable animations.
			function mouseover(d) {
				// Fill these circles with DarkRed while moused over, and make 
				// them solid filled circles.
				d3.select(this).style("opacity", 1)

				// Display the tooltip at the x,y coord on the #mapViz html area
				tooltip.style("top", (d3.event.pageY + 10) + "px")
					   .style("left", (d3.event.pageX + 10) + "px");
				tooltip.select(".name").html(d.name);
				tooltip.select(".field").html("Field: " + d.field + ", " + d.year);
				tooltip.select(".institution").html("Inst. :" + d.institution);
				tooltip.select(".city").html("City: " + d.city + ", " + d.current_country_name_acquired)
				tooltip.style("display", "block");
				}

			function mouseout(d) {
				// Make the circle attributes return to defaults and
				// tooltip disappear when moused off of.
				d3.select(this).style("opacity", .2)
				tooltip.style("display", "none")
				}

			// Make an animation when a circle is clicked.
			// http://christopheviau.com/d3_tutorial/
			// Make larger..
			function animateFirst() {
				d3.select(this)
				.transition()
				  .delay(0)
				  .duration(100)
				  .attr("r", 10)
				  .each("end", animateSecond)
				};
			// Then return to normal size.
			function animateSecond() {
				d3.select(this)
				  .transition()
				    .duration(200)
				    .attr("r", 2)
				    // Add for loop
				    //.each("end", animateFirst)
				};

			};


			var year_idx = 0;

			var year_interval = setInterval(function() {
				update(+years[year_idx]);
	
				year_idx++;

				if(year_idx >= years.length) {
					clearInterval(year_interval);
				}
			}, 1000);


		});

	});	

	//Functions:

	function zoomed() {

		//d3.event.sourceEvent.preventDefault();

		worldGroup.attr("transform", "translate(" + 
			d3.event.translate.join(",") + ")scale(" + d3.event.scale + ")" );
		
		//g.selectAll("path")
		//	.attr("d", path.projection(projection));
	}

	function dragstarted(d) {
		d3.event.sourceEvent.stopPropagation();
		d3.select(this).classed("dragging", true);
	}

	function dragged() {
		var p = d3.mouse(this);
		projection.rotate( [ λ( p[0] ), φ( p[1]) ] );
		svg.selectAll("path").attr("d", path);		
	}

	function dragended(d) {
		d3.select(this).classed("dragging", false)
	}

//var xy = mercator([longitude, latitude])

	</script>

</body>
</html>


<!--
			var force = d3.layout.force()
				.nodes(cities)
				.size([width, height])
				.on("tick", tick)
				.charge(300)
				.gravity(0.1)

			force.start()

			node = worldGroup.selectAll("circle")
				.data(force.nodes())
				.enter()
				.append("circle")
				.style("fill", "steelblue")
				.attr("r", 10)

			function tick() {
				
				node.each(messWithPosition());

				node.attr("cx", function(d) { return d.birth_x; })
					.attr("cy", function(d) { return d.birth_y})
			}

			function messWithPosition(){
				return function(d) {
					d.birth_x += 0
					d.birth_y += 0
				}
			}
*/ -->